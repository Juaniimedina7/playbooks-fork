settings:
  name: "GH SAST & DAST Workflow Audit: octoscan, gato-x, gh-workflow-auditor, semgrep"
  image: golang
  redacted:
  - GH_ACCESS_TOKEN

install:
  dependencies:
  - apt-get update -qq; apt-get install python3-pip -qqy >>/dev/null
  octoscan:
  - cd /tmp; git clone --depth 1 https://github.com/synacktiv/octoscan.git 2>>/dev/null; cd octoscan; go mod tidy 2>>/dev/null; go build
  gato-x:
  - cd /tmp; git clone --depth 1 https://github.com/AdnaneKhan/gato-x 2>>/dev/null; cd gato-x; python3 -m pip install . -q --disable-pip-version-check --root-user-action=ignore --break-system-packages 
  gh-workflow-auditor:
  - cd /tmp; git clone --depth 1 https://github.com/TinderSec/gh-workflow-auditor.git 2>>/dev/null; python3 -m pip install requests PyYAML -q --disable-pip-version-check --root-user-action=ignore --break-system-packages 
  semgrep:
  - pip install semgrep -q --disable-pip-version-check --root-user-action=ignore --break-system-packages 
  repo:
  - git clone --depth 1 https://github.com/${{REPO}}.git

sast:
  assertStdout: False
  octoscan:
    - find ./ -name "*.yml" | grep "github/workflows" | xargs -IX /tmp/octoscan/octoscan scan X
  semgrep:
    - semgrep --config 'p/github-actions' -q --max-chars-per-line 1024

dast:
  gato-x:
    assertStdoutNotContains: HIGH
    run:
      - export GH_TOKEN=${{GH_ACCESS_TOKEN}}; gato-x e --repository ${{REPO}} 
  gh-workflow-auditor:
    assertStderrNotContains: WARNING
    run:
      - export PAT=${{GH_ACCESS_TOKEN}}; cd /tmp/gh-workflow-auditor; python3 main.py --type repo ${{REPO}}
